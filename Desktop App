import tkinter as tk
from tkinter import messagebox
import requests
from datetime import datetime

API_URL = "https://api.coingecko.com/api/v3/simple/price"
QUERY_PARAMS = {"ids": "bitcoin", "vs_currencies": "usd"}

UPDATE_INTERVAL_MS = 30_000  # 30 seconds


class BitcoinPriceApp:
    def __init__(self, root):
        self.root = root
        root.title("Bitcoin Price")
        root.resizable(False, False)
        padding = {"padx": 12, "pady": 8}

        self.price_var = tk.StringVar(value="Fetching...")
        self.time_var = tk.StringVar(value="")

        frame = tk.Frame(root)
        frame.pack(**padding)

        title = tk.Label(frame, text="Bitcoin (BTC) price", font=("Segoe UI", 14, "bold"))
        title.grid(row=0, column=0, columnspan=2, pady=(0, 8))

        tk.Label(frame, text="Price (USD):", font=("Segoe UI", 10)).grid(row=1, column=0, sticky="w")
        tk.Label(frame, textvariable=self.price_var, font=("Segoe UI", 12)).grid(row=1, column=1, sticky="e")

        tk.Label(frame, text="Last update:", font=("Segoe UI", 9)).grid(row=2, column=0, sticky="w")
        tk.Label(frame, textvariable=self.time_var, font=("Segoe UI", 9)).grid(row=2, column=1, sticky="e")

        btn_frame = tk.Frame(root)
        btn_frame.pack(**padding)

        refresh_btn = tk.Button(btn_frame, text="Refresh", command=self.update_price)
        refresh_btn.pack(side="left", padx=(0, 6))

        quit_btn = tk.Button(btn_frame, text="Quit", command=root.quit)
        quit_btn.pack(side="right")

        # Start automatic updates
        self.update_price()

    def fetch_price(self):
        try:
            resp = requests.get(API_URL, params=QUERY_PARAMS, timeout=10)
            resp.raise_for_status()
            data = resp.json()
            usd = data.get("bitcoin", {}).get("usd")
            if usd is None:
                raise ValueError("Unexpected API response format")
            return float(usd)
        except Exception as e:
            # Propagate exception message to caller
            raise RuntimeError(f"Failed to fetch price: {e}")

    def update_price(self):
        try:
            price = self.fetch_price()
            self.price_var.set(f"${price:,.2f}")
            self.time_var.set(datetime.utcnow().strftime("%Y-%m-%d %H:%M:%S UTC"))
        except Exception as e:
            self.price_var.set("N/A")
            self.time_var.set("")
            # Show a non-blocking alert once
            messagebox.showwarning("Update failed", str(e))
        finally:
            # Schedule next update
            self.root.after(UPDATE_INTERVAL_MS, self.update_price)


if __name__ == "__main__":
    root = tk.Tk()
    app = BitcoinPriceApp(root)
    root.mainloop()
